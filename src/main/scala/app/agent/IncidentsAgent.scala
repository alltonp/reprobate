package app.agent

import server.ServiceFactory.dateFormats
import app.model.Incident
import app.server.AllRunsStatusUpdate
import im.mange.jetboot._
import im.mange.jetpac._
import im.mange.jetboot.widget.table.{TableHeaders, TableRow}
import im.mange.jetpac.css.Style

import scala.xml.Unparsed

//TODO: mouse over to see incident details ... start/finish etc
case class IncidentsAgent() extends Renderable {
  private val body = div(id = Some("incidentsBody")).styles(fontSize(smaller))
  private val panel = div(body).styles(marginTop("15px"))

  def render = panel.render

  def onAllRunsStatusUpdate(update: AllRunsStatusUpdate) =
    if (update.totalIncidents == 0) body.empty else body.fill(layout(update))

  private def layout(update: AllRunsStatusUpdate) = Bs.row(col(12, render(update.openIncidents, update.closedIncidents)))

  //TODO: pull out presentation
  private def render(open: List[Incident], closed: List[Incident]) = {
    R(
      if (open.nonEmpty) tablify(tableHeaders("Open Incidents: " + open.size), rows(open)) else R(),
      if (closed.nonEmpty) tablify(tableHeaders("Closed Incidents: " + closed.size), rows(closed)) else R())
  }

  //TODO: ideally lets give 1 and 3 more room
  private def tableHeaders(prefix: String) = headers(List(
    header(span(None, prefix).styles(color("#0088cc"))).styles(width("16%")),
    header(R("Environment")).styles(width("9%")),
//    header(R("Ref")).styles(width("7%")),
    header(R("Reason")).styles(width("43%")),
    header(R("Opened")).styles(width("12%")),
    header(R("Closed")).styles(width("12%")),
    header(R("Duration")).styles(width("8%"))
  ))

  private def rows(incidents: List[Incident]) = incidents.map(i => TableRow(None, List(
    R(i.probe.description),
    R(i.probe.env),
//    R(s"IN-${i.id}"),
    span(None, R(Unparsed(i.failures.mkString("<br/>")))).styles(Style("word-break", "break-all")),
    R(dateFormats().today(i.start)),
    R(i.finish.fold("-"){dateFormats().today(_)}),
    R(dateFormats().ago(i.openDuration))
  )))

  //TODO: pull out a widget
  private def tablify(h: TableHeaders, r: List[TableRow]) =
    div(None, bsTable(h, r).classes(tableCondensed, tableStriped).styles(width("100%"), marginBottom("0px"))).classes("round-corners")
}
